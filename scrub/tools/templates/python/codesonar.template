#!/bin/bash -x
find ${{SOURCE_DIR}} -type f -name '*.py' > ${{TOOL_ANALYSIS_DIR}}/codesonar_file_list.txt
${{CODESONAR_PATH}}/codesonar analyze ${{TOOL_ANALYSIS_DIR}}/SCRUBAnalysis -project ${{CODESONAR_PROJ_NAME}} -foreground -auth certificate -hubcert ${{CODESONAR_CERT}} -hubkey ${{CODESONAR_KEY}} ${{CODESONAR_HUB}} ${{CODESONAR_PATH}}/cspython ${{CODESONAR_PATH}}/../../third-party/pylint-sarif/pylint2cso.py --inputsfile ${{TOOL_ANALYSIS_DIR}}/codesonar_file_list.txt
aid=`cat ${{TOOL_ANALYSIS_DIR}}/*/aid.txt`
cd ${{TOOL_ANALYSIS_DIR}}
${{CODESONAR_PATH}}/codesonar get -auth certificate -hubcert ${{CODESONAR_CERT}} -hubkey ${{CODESONAR_KEY}} ${{CODESONAR_GET_FLAGS}} ${{CODESONAR_HUB}}/analysis/$aid-allwarnings.sarif
python3 ${{SCRUB_PATH}}/utils/translate_results.py ${{TOOL_ANALYSIS_DIR}}/*.sarif ${{RAW_RESULTS_DIR}}/codesonar_raw.scrub ${{SOURCE_DIR}} scrub
